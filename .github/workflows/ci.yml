name: CI

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:
    inputs:
      e2e:
        description: "Run real e2e tests (requires docker + devcontainer; slow)"
        type: boolean
        default: false

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - name: Fmt
        run: cargo fmt --all --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Test
        run: cargo test --locked

  e2e:
    name: E2E (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.e2e
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install devcontainer CLI
        run: npm i -g @devcontainers/cli

      - name: Docker info
        run: |
          docker --version
          docker info

      - name: E2E
        env:
          PC_E2E: "1"
        run: cargo test --locked --test e2e_real -- --ignored --nocapture

