services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ..:/workspaces/workspace:cached
      - uv_cache:/home/vscode/.cache/uv
      - pip_cache:/home/vscode/.cache/pip
      - pnpm_home:/home/vscode/.local/share/pnpm
      - npm_cache:/home/vscode/.npm
      - vscode_extensions:/home/vscode/.vscode-server/extensions
    environment:
      UV_CACHE_DIR: /home/vscode/.cache/uv
      PIP_CACHE_DIR: /home/vscode/.cache/pip
      NPM_CONFIG_CACHE: /home/vscode/.npm
      PNPM_HOME: /home/vscode/.local/share/pnpm
      PATH: /home/vscode/.local/share/pnpm:${PATH}
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"
    command: sleep infinity

  desktop:
    image: lscr.io/linuxserver/webtop:ubuntu-kde
    profiles: ["desktop"]
    shm_size: "1gb"
    environment:
      PUID: "1000"
      PGID: "1000"
      TZ: ${TZ:-Etc/UTC}
      USERNAME: ${WEBTOP_USERNAME:-vscode}
      PASSWORD: ${WEBTOP_PASSWORD:-}
    volumes:
      - desktop_home:/config
    ports:
      - "127.0.0.1::3000"
    restart: unless-stopped

volumes:
  uv_cache:
    external: true
    name: ${DEVCONTAINER_CACHE_PREFIX:-devcontainer}-uv-cache
  pip_cache:
    external: true
    name: ${DEVCONTAINER_CACHE_PREFIX:-devcontainer}-pip-cache
  pnpm_home:
    external: true
    name: ${DEVCONTAINER_CACHE_PREFIX:-devcontainer}-pnpm-home
  npm_cache:
    external: true
    name: ${DEVCONTAINER_CACHE_PREFIX:-devcontainer}-npm-cache
  vscode_extensions:
    external: true
    name: ${DEVCONTAINER_CACHE_PREFIX:-devcontainer}-vscode-extensions
  desktop_home: {}
